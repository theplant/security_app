require "cgi"

username = "admin"
cookie_jar = "tmp/1-cookie-jar-#{username}"

def get_csrf cookie_jar
  resp = `curl -4 -i --silent -c #{cookie_jar} -b #{cookie_jar} "http://localhost:3000"`

  resp.match(/content="(.+?)" name="csrf-token"/)[1] rescue puts resp
end

def try_login csrf, cookie_jar, username, password
  puts "attempt login #{password}"
  resp = `curl -4 -i --silent -c #{cookie_jar} -b #{cookie_jar} -X POST -d "session[username]=#{username}" -d "authenticity_token=#{CGI.escape csrf}" -d "session[password]=#{password}" "http://localhost:3000/session"`
  code = resp.match(%r|^HTTP/1.1 (\d{3})|m)[1]
  raise "#{username}:#{password} got #{code}" if code[0] == "3"
end

csrf = get_csrf cookie_jar

password = "cata"
loop do
  try_login csrf, cookie_jar, "admin", password
  password.succ!
end
